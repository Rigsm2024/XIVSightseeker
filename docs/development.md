# 開発経緯

## 要約
- きっかけ
  - 自分がゲーム内コンテンツをクリアしたかった ([探検手帳について](#探検手帳ときっかけ))
  - 転職活動にむけてポートフォリオを作りたかった ([フレームワーク選定](#フレームワーク選定))
- こだわり
  - 役に立つサイトを作りかった ([要件定義](#アプリ構想))
  - シンプルだけど使いやすく ([デザイン](#サイトデザインについて))
- 楽しんだこと
  - やっぱり自分のスマホで動くサイトを見れた時が嬉しかった ([プロトタイプ](#プロトタイプ作成))
  - 自分なりに綺麗に実装できたこと ([リファクタリング](#nextjsのリファクタリング))
- 苦労したこと
  - デプロイが本当に大変だった！ ([デプロイ](#プロトタイプのデプロイ))
- 所感
  - やってよかった！ ([所感](#所感))


---
# 開発経緯 (時系列)

## 探検手帳ときっかけ
- ゲーム内フィールドの特定地点を探すという探索系コンテンツ
- ターゲットにした「新生の探検手帳」はとても難易度が高い
  - 地点には目印が存在せず、自分でその場に立たないと正解かどうかわからない
  - ゲーム内時間の特定の時間帯のみ達成可能 (例: AM8:00 - AM12:00など)
  - 各項目には天候条件があるが、もちろん天候はランダム (例: 晴れ、雨など)
  - 限られた時間に、ランダムの天候条件が揃うのを願い、見えない地点を探索する、そしてその項目が80個ある...
- これまでも攻略可能ではあった
  - 優秀な探検手帳のみの攻略サイト、ゲーム内の天気予報サイトは存在する
  - が、時間と天候と自分の達成項目を睨めっこする作業はとてもおっくうであり面倒であり耐え難い
- それら全てを自動でやってくれたら、ハードルが下がってやる気も起きるではないかと考えた
- 加えて転職活動のポートフォリオにできたら一石二鳥！

## アプリ構想
- 新生の探検手帳をやるにあたって、如何にハードルを下げるかにこだわってシステム要件を考えた
- 実現したかったこと
  - 探検手帳攻略に必要な情報を詰め込みたい
    - 今！どの項目が達成可能かの順で表示できたらやろうと思えるのではないか
    - 地図表示は必須、どこを目指すべきかをざっくり把握してもらえる
    - 付随情報は表示するが、目立たなくすることで困った時に見てもらえるはず (緯度経度や、時間天候の条件など)
  - 表示はカスタマイズできたら嬉しいか
    - 表示順は達成可能もそうだが、番号順でも表示できたら使い勝手が良さそう　(自分の達成具合を把握する時など)
    - ネタバレ具合を調整できるといいのだろうか (地点探しを自分でやりたい人は地図を非表示にできるようにするなど)
    - Webサイトに自分の達成進捗を保存できるようになっていたら捗るはず！
  - これらアイデアは先達の優秀な攻略サイト様を大いに参考にした。自分は組み合わせただけ。
- 実現するにあたって考えたこと
  - Webサイトにしてハードルを下げたかった
    - デバイスに依存しない (PCでもスマホでも使いたい)
    - アプリダウンロードや会員登録などが不要
    - Googleのスプレッドシートを使わなくていい
  - 自分のスキルアップに利用したかった
    - モダンなフレームワークを使ってみたい
    - クラウドやデプロイとやらを体験してみたい

## サイトデザインについて
- 自分には美的センスは特にない為、UXの基礎に従ってシンプルに作ってみた
- 情報の優先度に従って表示の目立たせ具合を調整している
  - 地図を一番大きく表示
    - どこに行くべきかを最初に把握してもらいたい
    - 地図の見てくれに紐づけて、その項目が終わったかやどの辺になるのかなど大事な情報をまとめて把握できると判断
    - とりあえず移動開始して、移動中に細かい情報を確認するという流れで効率化もできる
    - 別サイトを触っている時に、地図表示が一番イメージが湧くという自分の経験も元にしている
  - 次いで残り時間を大きく表示
    - いつまで可能なのか、いつから可能なのか、しばらく無理なのかをパッと見えるようにした
    - 行動開始すべきか否かをすぐに判断できるようにしている
    - 別サイトを触っている時に、残り時間が強調されていると便利だと感じた自分の経験も元にしている
  - 「エモート」はアイコン表記で
    - 地点に到達してからサイトを見直し、その時に目に入るくらいの目立ち度で十分なため、右端に配置
    - ゲーム内で見慣れた表現方法を採用し、アイコンとしている
  - 項目番号とエリア名はカードのタイトルとして表示
    - タイトルは思ったより目に入らないことを利用した
    - 項目番号は自分がどの項目をやろうとしているのか把握するのに必要
    - エリア名は移動先を把握するために必要 (テレポ先を探すため)
  - 細かい情報は表示するが、目立たないようにして画面がごちゃごちゃしないようにしている
    - 時間: いつ達成可能なのかを表記している。残り時間表記で達成可能かどうかは分かるので、参照したい時のみで十分
    - 天気: どの天候の時に達成可能なのかを表記している。こちらも参照したい時のみで十分
    - 緯度経度: 細かい座標値を記載。地図表示で大まかに行くべき所は把握できるので、迷った時に参照できれば十分
- その他細かいデザインについて
  - 全体的な見た目は、ゲーム内のメニュー画面っぽさを真似して親近感が湧くようにしてみた
  - テキスト表記とヒントテキストはドロップダウン式にした。最初から全て出すとサイトがうるさくなってしまうため。
  - メニューダイアログのデザインはiPhoneのAppleMusicを真似した
  - 完了ボタンはTODOリストのチェックマークをイメージしてデザインした

## フレームワーク選定
- コンテナ
  - とりあえずDocker
  - さすがに触ったことがないのはまずいと思っての選定
- フロントエンド
  - TypeScriptを触りたかった
  - フレームワークは何かしら使いたかったので、軽く調べた結果SPA向けにはnextjsが熱いとなり採用
  - ベタのcssは経験があったので、新しいものをと思いtailwindで作ってみることにした
- バックエンド
  - Goを触りたかった
  - Goのエンジニアは平均給料が高いらしいという情報に惹かれたのは間違いない
  - こちらもせっかくなのでと思い、Ginを採用してみることに
- データベース
  - ポートフォリオにするにあたって、一応DBの経験もあることを示したかった
  - こちらは慣れているpostgresを採用
- プラットフォーム
  - この時点ではAWSなのかなぁくらいの軽い認識
  - とりあえずコンテナだしなんとかなるでしょう程度でまずは動き始めた

## プロトタイプ作成
- 触ったことのないフレームワークだらけだったので、ChatGPTとBingAIに質問を投げまくる
- PCのChrome -> nextjs -> goでHelloWorldを表示するまでに一週間くらいはかかった
- HellowWorldできた構成で順番に機能実装を進めていく
- バックエンド
  - DB設計は適度に正規化、Goで読み込んでみる
  - Ginにはしてみたが、APIの数もリスクエスト数も少なかったのでフレームワークの恩恵はほぼ受けていない
  - 天気予報アルゴリズムを実装してみたが、言語特性としてリッチなUtil関数の少なさに戸惑う
    - 「.mapがない！？for文ですか！？」など
    - 書式などはChatGPTに聞くことでそこまで苦労はしなかった
  - Go経験者の知人に相談したこともあり、なんとなく言語特性に触れられた気がした
    - 所感：シンプルにしか書けない制約は、コードをシンプルにしなさいという言語開発者の優しさなのではと思った
- フロントエンド
  - かつてjQuery + フレームワークなしのjsでサイトを作っていたこともあり、Reactの概念に戸惑う
    - DOMにid属性を用意し、jsでクラス追加をして怒られて？？？となるなど
  - サーバサイドとクライアントサイドもよく分からず、getServerSidePropsに重い処理を全て入れていた
  - tailwindに関しては、最初はとてももどかしかった
    - 自分でcssを書いた方が早い！
    - tailwindチートシートと睨めっこするのが大変
  - 慣れてきた頃には早くなっていた印象
    - 特にマージンやflexなど、細かいがクラスにするほどでもない設定をcssに書かなくていいのは楽だと思った
- 「実現したかったこと」はたくさんあったが、全てを実装してからデプロイすると大変と判断
- まずは本当に必要最低限の機能を作って、とにかくクラウドにデプロイしてみようと考えた

## プロトタイプのデプロイ
- まずは最低限の機能を完成させた
  - バックエンドから探検手帳と天気予報のデータを取得できる
  - フロントエンドで天気予報を元にどの項目が達成可能かの順でオブジェクトを生成できる
  - HTMLで項目ごとにカード形式で情報表示することができる
  - Dokcerで起動し、ブラウザからlocalhostでサイト閲覧することができる
- プラットフォーム選定の四苦八苦
  - nextjsはAmplifyが楽という情報を聞き、まずは調べてみる
    - おや、Amplifyはコンテナをデプロイする感じではない？？
    - AWSにもコンテナがあるらしい
    - docker-composeが使えない...？そんな...
    - どうやらnextのみをAmplifyにデプロイして、バックとDBはコンテナとして別にデプロイするらしい
    - フロントとバックでプラットフォームを変えるのはちょっと...
  - コンテナのままデプロイ可能なサービスを探し始める
    - AWSのコンテナサービスも調べたが、docker-composeが使えないと分かり断念
    - Dockerにもクラウドサービスはあるが、自分でサーバを用意する必要ありと分かり断念
    - コンテナサービスを提供しているGoogle Cloud Runに行き着く
- Google Cloud Runで頑張る
  - 結局docker-composeは使えなかったが、さすがに諦めてコンテナをデプロイする方針にした
    - コンテナデプロイならAWSでもよかったが、ランニングコスト的にGoogleの方が安価そうであることもあった
  - DBはちゃんと管理するととんでもないランニングコストがかかると分かり、postgresはやめることにした
    - Writeがなかったことも幸いし、データ定義は全てjsonに移行
    - Goのサーバ起動時にjsonを読み込み、キャッシュとして溜め込む方式にした
    - リポジトリinterfaceとDTOでやりとりする設計にしていたため、DB -> jsonの変更はスムーズに行えた
  - なんとかフロントとバックのサービス二つでデプロイすることに成功
  - デプロイは楽そうと言う理由でGitHubへのプッシュをトリガにするクラウドビルドを採用した
- 苦心の末、とりあえず最低限のサイトを公開するに至る
  - スマホ、PC双方で閲覧可能になったことも確認

## サイト改善
- 問題点
  - URLがダサい
  - 起動がとんでもなく遅い！
- カスタムドメインの導入
  - URL -> https://xivsightseeker-prototype-1045314413273.asia-northeast1.run.app
  - 動機
    - Cloud RunのデフォルトURLのため、あまりかっこがつかないと考えた
    - 実害もあり、FF14プレイヤーに宣伝する際に見慣れないURLだと警戒される可能性もあった
  - やったこと
    - お名前.comでドメインを取得 -> xivsightseeker.com
    - Google Cloud Runでカスタムドメイン設定を行い、そこに取得したドメインを設定
- 起動が遅い問題
  - 起きていたこと
    - 無課金の場合、Google Cloud Runのコンテナは15分間リクエストが無いとスリープ状態になる
    - スリープ後にサイトを開こうとすると、15秒以上かかっていた (なんなら初回はエラーでサイトが開けない)
    - 開発モードのnextjsをデプロイしていたため、毎度コンパイルが走っていたことが一番クリティカルだった (本当に無知)
  - やったこと
    - 課金はさすがに避けたかったので、起動を如何に早くするかを検討しはじめた
    - バックエンドのリストラ
      - 改めて考えると、このアプリにとってコンテナが複数あることに対してメリットがなかった
      - デメリットとして二つのコンテナ起動を待つ必要が出てきたので、デメリットが強いと判断してバックエンドをリストラ
      - 勉強にはなったが、本来この規模のアプリはnextjs一本で十分だった
    - プロダクションビルドの導入
      - nextjsの起動を早くするために、Dockerfileはプロダクションビルドをするように変更
      - 開発モードではdocker-compose.yml経由でDockerfile.localからビルドするようにした
    - nextjsのサーバサイドレンダリングの見直し
      - getServerSidePropsに処理を詰め込みすぎていたので、まずは何かしらの画面を表示するようにしてみた
      - 完全なページが表示されるよりも、少しずつ表示されていく方がユーザは耐えられるのではないかと判断した
      - 細かな経緯は後述 (nextjsのリファクタリング)
  - 結果的に起動時の表示は劇的に改善された
    - スリープ復帰時にあたったとしても4秒程度で画面は表示され、そこから情報が増えていく
    - 4秒でも本来は耐え難い時間ではあるが、一旦機能追加と一般公開を優先している

## nextjsのリファクタリング
- 先のnextjs一本化に伴い、大幅にリファクタリングを行った
- フォルダ構成
  - ぐちゃぐちゃだったので整理した
  - バックエンド系はfeaturesに、クライアント系はcomponentsにした
- APIの導入
  - goで作っていたAPIをほぼそのままnextjsのAPIで再現した
  - 使ってみて分かったが、API化はとても捗った
    - 重めの処理をサーバサイドに押し付けられる
    - APIを呼べば整ったデータがもらえる安心感が大きく、クライアント側での処理に集中できる
    - 何気にデバッグも捗り、ChromeのデバッグツールからAPIを叩いてデータを覗けるのは大きかった
- 状態管理
  - 基本的にReactのuseStateを基準に状態管理するよう設計変更
  - 表示更新イベントが乱立していたので、設計を見直した
    - 設計にあたり、更新となるイベントを一覧化
      - 項目の残り時間が0になる、ユーザがフィルタ情報を更新した、など
    - 大元のuseStateを定義し、それ起因でViewが更新されるように処理を一本化した
      - データ1: 探検手帳データと天気予報結果を格納したオブジェクト
        - 項目の残り時間が0になると更新される
      - データ2: フィルタ
        - ユーザが何かしらの設定変更をすると更新される
      - どちらかのイベントが発生するとuseStateが動き、Viewが更新される流れ
      - View更新が1ルートになったので設計がシンプルになったと考えている
- 機能追加
  - ようやく使い物になってきたのがやる気につながったのか、一気に「実現したかったこと」の機能追加をしていく
  - 状態管理のリファクタリングにより、更新イベントを伴う機能追加がスムーズに行えるようになったことも大きい
    - LocalStorageの導入
    - 表示順変更や達成項目表示非表示機能
    - 長時間予報機能
  - この辺りでフレンドに宣伝し、実際に使ってもらっている

## 所感
- 自分で使ってみて
  - 実際に自分でこのサイトを使って探検手帳を攻略してみたが、すこぶる捗った (無事に攻略済み)
  - 自画自賛になってしまうが、とても使いやすい攻略サイトを作れたと自負している
  - 自分が使いたいものを作ったので、サイトを良くしたいという思いはずっと持てていた
  - このサイトが他プレイヤーの助けにもなれたとしたら、とても嬉しい
- 本当に勉強になった
  - Reactを始め、モダンなフレームワークに触れることができた
  - デプロイまでの流れでdockerやコンテナのこと、引いてはドメインまでたくさんの流れを経験できた
  - 役に立つサイトを目指していたことが、困りごとに本気で向き合う動機になっていたように思う
- うまくいったこと
  - とりあえずでも最低限動くものをデプロイしたのは効いたと思った
    - Done is better than perfect.を実感した
    - 動くものがあるという安心感
    - 人に見せることも可能になる
    - 本番環境での検証が捗る
  - 最終的にnextjs一本に絞ってよかった
    - インフラもアーキテクチャも全てシンプルになった
    - コンテナは増やせばいいものではないことを学んだ
    - Viewのイベント周りは綺麗に実装できたと考えている
- もっとうまくやりたかったこと
  - テスト駆動ができていない
  - AWSの方が企業に入った時に経験が活かせそう
  - スリープ復帰時の4秒問題が解決できていない
  - オシャレ度が足りない
  - ネタバレへの配慮をもっとしたかった